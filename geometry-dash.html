<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Geometry Dash â€” MVP</title>
<style>
  :root{
    --bg1: #1e293b;
    --bg2: #0f1724;
    --accent: #ff3b3b;
    --ground: #0ea5a4;
    --spike: #0b1020;
    --ui: #e6eef7;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--ui);}
  .wrap{display:flex;flex-direction:column;align-items:center;gap:12px;padding:18px}
  canvas{background:linear-gradient(180deg,#7fd3ff 0,#4fb3ff 60%);border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,0.5)}
  .controls{display:flex;gap:8px;align-items:center}
  .panel{background:rgba(255,255,255,0.04);padding:8px 12px;border-radius:8px}
  .big{font-weight:800;font-size:18px}
  .muted{font-size:13px;color:#cfe}
  button{background:var(--accent);border:none;padding:8px 10px;border-radius:8px;color:white;font-weight:800;cursor:pointer}
  .small-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px;border-radius:8px;color:var(--ui);cursor:pointer}
  @media (max-width:760px){ canvas{width:92vw;height:46vw} }
</style>
</head>
<body>
<div class="wrap">
  <div style="display:flex;gap:12px;align-items:center;">
    <div class="panel big" id="levelLabel">Level 1</div>
    <div class="panel muted">Score: <span id="score">0</span></div>
    <div class="panel muted">Highscore: <span id="high">0</span></div>
    <div class="panel muted">Status: <span id="status">Ready</span></div>
  </div>

  <canvas id="c" width="960" height="300" tabindex=0></canvas>

  <div class="controls">
    <button id="startBtn">Start / Restart</button>
    <button id="nextBtn" class="small-btn">Next Level</button>
    <button id="muteBtn" class="small-btn">Mute</button>
    <div style="width:16px"></div>
    <div class="muted">Controls: Space / Click to jump</div>
  </div>
</div>

<script>
// --- Canvas setup ---
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let W = canvas.width, H = canvas.height;

// UI elements
const levelLabel = document.getElementById('levelLabel');
const scoreEl = document.getElementById('score');
const highEl = document.getElementById('high');
const statusEl = document.getElementById('status');
const startBtn = document.getElementById('startBtn');
const nextBtn = document.getElementById('nextBtn');
const muteBtn = document.getElementById('muteBtn');

let muted = false;
muteBtn.addEventListener('click', ()=>{ muted = !muted; muteBtn.textContent = muted ? 'Unmute' : 'Mute'; });

// Audio helper
const AudioCtx = new (window.AudioContext || window.webkitAudioContext)();
function beep(freq=440,duration=0.08,vol=0.12,type='sine'){
  if(muted) return;
  const o=AudioCtx.createOscillator(), g=AudioCtx.createGain();
  o.type = type; o.frequency.value = freq; g.gain.value = 0;
  o.connect(g); g.connect(AudioCtx.destination);
  const now = AudioCtx.currentTime;
  g.gain.linearRampToValueAtTime(vol, now + 0.01);
  g.gain.exponentialRampToValueAtTime(0.001, now + duration + 0.01);
  o.start(now); o.stop(now + duration + 0.02);
}
window.addEventListener('pointerdown', ()=>{ if(AudioCtx.state==='suspended') AudioCtx.resume(); }, { once:true });

// --- Game state ---
let running = false;
let levelIndex = 0;
let score = 0;
let high = parseInt(localStorage.getItem('gd_high')||'0',10);
highEl.textContent = high;

// Player
const player = { x:150, y:0, w:34, h:34, vy:0, grounded:true, vx:0 };

// Camera/world
let worldX = 0;
let scrollSpeed = 220;

// Physics
const GRAV = 1600;
const JUMP_V = 520;

// --- Levels ---
const LEVELS = [
  { name:'Stereo Madness', length:1200, speedMul:1, platforms:[{x:0,w:1200,y:H-80}], spikes:[{x:420,w:32},{x:720,w:32}], gaps:[{x:300,w:80},{x:860,w:100}] },
  { name:'Back on Track', length:1400, speedMul:1.05, platforms:[{x:0,w:1400,y:H-80}], spikes:[{x:300,w:32},{x:680,w:32},{x:1100,w:32}], gaps:[{x:420,w:140},{x:900,w:160}] },
  { name:'Polargeist', length:1600, speedMul:1.08, platforms:[{x:0,w:1600,y:H-80}], spikes:[{x:320,w:32},{x:480,w:32},{x:760,w:32},{x:980,w:32},{x:1300,w:32}], gaps:[{x:600,w:100},{x:1420,w:90}] },
  { name:'Dry Out', length:1800, speedMul:1.12, platforms:[{x:0,w:1800,y:H-80}], spikes:[{x:260,w:32},{x:560,w:32},{x:1260,w:32}], gaps:[{x:420,w:160},{x:900,w:160},{x:1500,w:140}] },
  { name:'Base After Base', length:2000,speedMul:1.17, platforms:[{x:0,w:2000,y:H-80}], spikes:[{x:400,w:32},{x:440,w:32},{x:480,w:32},{x:920,w:32},{x:960,w:32}], gaps:[{x:700,w:120},{x:1320,w:140}] },
  { name:'Cant Let Go', length:2200,speedMul:1.22, platforms:[{x:0,w:2200,y:H-80}], spikes:[{x:300,w:32},{x:460,w:32},{x:620,w:32},{x:900,w:32},{x:1500,w:32}], gaps:[{x:1050,w:120},{x:1800,w:120}] },
  { name:'Jumper', length:2400,speedMul:1.28, platforms:[{x:0,w:2400,y:H-80}], spikes:[{x:350,w:32},{x:500,w:32},{x:650,w:32},{x:1000,w:32},{x:1400,w:32}], gaps:[{x:760,w:90},{x:1180,w:110},{x:1980,w:120}] },
  { name:'Time Machine', length:2800,speedMul:1.36, platforms:[{x:0,w:2800,y:H-80}], spikes:[{x:260,w:32},{x:420,w:32},{x:580,w:32},{x:860,w:32},{x:1220,w:32},{x:1700,w:32},{x:2140,w:32}], gaps:[{x:700,w:140},{x:1500,w:160},{x:2400,w:160}] }
];

// --- Build platforms & spikes ---
function buildSegments(level){
  const base = [];
  for(const p of level.platforms){
    let cursor=p.x, end=p.x+p.w;
    const gaps=(level.gaps||[]).filter(g=>g.x<end && g.x+g.w>cursor).sort((a,b)=>a.x-b.x);
    for(const g of gaps){ if(g.x>cursor) base.push({x:cursor,w:g.x-cursor,y:p.y}); cursor=Math.max(cursor,g.x+g.w);}
    if(cursor<end) base.push({x:cursor,w:end-cursor,y:p.y});
  }
  return base;
}
function buildSpikes(level){
  const spikes=[];
  const segs=buildSegments(level);
  for(const s of level.spikes){
    const seg=segs.find(seg=>s.x>=seg.x && s.x<=seg.x+seg.w);
    spikes.push({x:s.x, w:s.w, y: seg ? seg.y : level.platforms[0].y});
  }
  return spikes;
}

// --- Game runtime ---
let currentLevel=null, segments=[], spikes=[], levelLength=0;

function loadLevel(i){
  levelIndex=Math.max(0,Math.min(i,LEVELS.length-1));
  currentLevel=LEVELS[levelIndex];
  levelLabel.textContent=`Level ${levelIndex+1}: ${currentLevel.name}`;
  levelLength=currentLevel.length;
  scrollSpeed=220*currentLevel.speedMul;
  segments=buildSegments(currentLevel);
  spikes=buildSpikes(currentLevel);
  player.x=150; player.vx=0;
  player.y=H-80-player.h;
  player.vy=0;
  player.grounded=true;
  score=0;
  updateUI('Ready');
}

// --- Start / Next ---
startBtn.addEventListener('click', () => {
  loadLevel(levelIndex);
  running=true;
  statusEl.textContent='Running';
  player.vx = 220; // player starts moving right
});
nextBtn.addEventListener('click', () => {
  loadLevel(levelIndex+1);
  running=false;
  statusEl.textContent='Loaded';
});

// --- Input ---
function doJump(){ if(!running) return; if(player.grounded){ player.vy=-JUMP_V; player.grounded=false; beep(840,0.08,0.12,'square'); } }
window.addEventListener('keydown', e=>{ if(['Space','ArrowUp','KeyW'].includes(e.code)){ e.preventDefault(); doJump(); } });
canvas.addEventListener('mousedown', doJump);
canvas.addEventListener('touchstart', e=>{ doJump(); e.preventDefault(); }, {passive:false});

// --- Collision ---
function checkSpikeCollision(){
  const px=player.x + player.vx * 0; // position in world
  const py=player.y;
  for(const s of spikes){
    const sx=s.x, sw=s.w, sy=s.y, sTop=sy-18;
    if(px+player.w>sx && px<sx+sw && py+player.h>sTop) return true;
  }
  return false;
}
function groundUnderPlayer(){
  const px = player.x;
  for(const seg of segments){ if(px + player.w/2 >= seg.x && px + player.w/2 <= seg.x + seg.w) return seg.y; }
  return null;
}

// --- UI ---
function updateUI(status){ statusEl.textContent=status; updateScoreUI(); }
function updateScoreUI(){ scoreEl.textContent=Math.floor(score); highEl.textContent=high; }

// --- Game loop ---
let last=performance.now();
function loop(now){
  const dt = Math.min(0.033,(now-last)/1000);
  last=now;

  if(running){
    player.x += player.vx*dt;
    worldX = player.x - 150; // camera follows player

    player.vy += GRAV*dt;
    player.y += player.vy*dt;

    const gY = groundUnderPlayer();
    if(gY!==null){
      const ty=gY-player.h;
      if(player.y+player.h>ty && player.vy>=0){ player.y=ty; player.vy=0; player.grounded=true; }
    } else { player.grounded=false; if(player.y>H+60) die(); }

    if(checkSpikeCollision()) die();

    if(player.x >= levelLength-200){
      running=false;
      statusEl.textContent='Complete!';
      beep(1200,0.2,0.18,'sine');
      if(score>high){ high=Math.floor(score); localStorage.setItem('gd_high',high); }
    }

    score += player.vx*dt*0.02;
    updateScoreUI();
  }

  render();
  requestAnimationFrame(loop);
}

// --- Death ---
function die(){ running=false; statusEl.textContent='Game Over'; beep(160,0.25,0.18,'sawtooth'); if(Math.floor(score)>high){ high=Math.floor(score); localStorage.setItem('gd_high',high); } updateScoreUI(); }

// --- Render ---
function render(){
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle='#7fd3ff'; ctx.fillRect(0,0,W,H);

  ctx.globalAlpha=0.2;
  for(let i=0;i<5;i++){
    const cx=((i*330 - worldX*0.2)%(W+200))-100;
    ctx.fillStyle='#ffffff';
    ctx.beginPath(); ctx.ellipse(cx+60,60+i*8,60,20,0,0,Math.PI*2); ctx.fill();
  }
  ctx.globalAlpha=1;

  ctx.save();
  ctx.translate(-worldX,0);

  for(const seg of segments){
    ctx.fillStyle='#0d9488'; ctx.fillRect(seg.x,seg.y,seg.w,H-seg.y);
    ctx.fillStyle='rgba(255,255,255,0.06)'; ctx.fillRect(seg.x,seg.y,seg.w,6);
  }

  for(const s of spikes){
    ctx.fillStyle='#0b1020';
    const sx=s.x, sy=s.y, sw=s.w, sh=18;
    ctx.beginPath(); ctx.moveTo(sx,sy); ctx.lineTo(sx+sw/2,sy-sh); ctx.lineTo(sx+sw,sy); ctx.closePath(); ctx.fill();
  }

  ctx.fillStyle='#ffd166';
  ctx.fillRect(levelLength-200,H-80-120,40,120);

  ctx.fillStyle='#ff3b3b'; ctx.fillRect(player.x,player.y,player.w,player.h);
  ctx.strokeStyle='#00000055'; ctx.lineWidth=2; ctx.strokeRect(player.x,player.y,player.w,player.h);

  ctx.restore();

  const progress=Math.min(1,player.x/Math.max(1,levelLength-200));
  ctx.fillStyle='#ffffff22'; ctx.fillRect(20,10,W-40,8);
  ctx.fillStyle='#ffcc33'; ctx.fillRect(20,10,(W-40)*progress,8);
}

// --- Resize ---
function fitCanvas(){
  const ratio=16/5;
  const maxW=Math.min(window.innerWidth-80,960);
  let cw=maxW, ch=Math.round(cw/ratio);
  if(ch>window.innerHeight-220){ ch=window.innerHeight-220; cw=Math.round(ch*ratio); }
  canvas.style.width=cw+'px'; canvas.style.height=ch+'px';
}
window.addEventListener('resize',fitCanvas);
fitCanvas();

// --- Start loop ---
requestAnimationFrame(loop);

// dblclick for next level
canvas.addEventListener('dblclick',()=>{ loadLevel(levelIndex+1); });

</script>
</body>
</html>
